#!/bin/bash
set -e

pushd /extension
# always install inside the running container
flit install --user --python=/usr/bin/python --symlink --extras=test
popd

server() {
  exec /usr/local/bin/gunicorn -b 0.0.0.0:5000 --name redash -w${REDASH_WEB_WORKERS:-4} redash.wsgi:app
}

create_tables() {
  pushd /app
  /extension/bin/wait-for-it.sh postgres:5432 -- /app/manage.py database create_tables
  popd
}

tests() {
  export REDASH_DATABASE_URL="postgresql://postgres@postgres/tests"
  create_tables

  if [ $# -eq 0 ]; then
    TEST_ARGS=/extension
  else
    TEST_ARGS=$@
  fi
  pytest $TEST_ARGS
}

case "$1" in
  tests)
	shift
	tests $@
;;
  ci)
	shift
	tests $@
  bash <(curl -s https://codecov.io/bash) -s /tmp
;;
  create_tables)
	shift
	create_tables
;;
  manage)
	shift
	exec /app/manage.py $*
;;
  server)
	shift
	server $@
;;
  *)
	exec "$@"
;;
esac
